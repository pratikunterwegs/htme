---
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r}
# data processing
library(data.table)
library(atlastools)
library(sf)

# plotting
library(ggplot2)
library(ggspatial)
library(magick)
```

```{r}
# get data
data <- fread("data/whole_season_tx_0435.csv")

# convert time to seconds from ms
data[, time := round(TIME / 1000)]

data[, time := as.POSIXct(time, tz = "Amsterdam", origin = "1970-01-01")]
```

```{r}
# filter out before specific time
data_filter <- atl_filter_covariates(
  data = data,
  filters = "time > '2018-08-19 18:31:00 Amsterdam'"
)

# select one day after start time
data_filter <- atl_filter_covariates(
  data = data_filter,
  filters = c("time < (time[1] + (18 * 3600))")
)
```

```{r}
# add speed
data_filter[, c(
  "speed_in", "speed_out",
  "angle"
) := list(
  atl_get_speed(data_filter,
    x = "X", y = "Y", time = "time",
    type = "in"
  ),
  atl_get_speed(data_filter,
    x = "X", y = "Y", time = "time",
    type = "out"
  ),
  atl_turning_angle(data_filter, x = "X", y = "Y", time = "time")
)]
```

## remove sd and speed

```{r}
data_filter_sd_speed <- atl_filter_covariates(
  data = data_filter,
  filters = c(
    "SD < 100",
    "((speed_in < 20 & speed_out < 20))"
  )
)
```

## do median smooth

```{r}
data_smooth <- copy(data_filter_sd_speed)

atl_median_smooth(
  data = data_smooth,
  x = "X", y = "Y", time = "TIME", moving_window = 11
)
```

## plot showing median smooth

```{r}
# set limits
xlim <- c(650600, 650950)
ylim <- c(5901815, 5902000)

legend_label <- c(
  "raw" = "Raw data",
  "outliers" = "Unrealistic\nmovement",
  "filtered" = "Filtered data",
  "smooth" = "Median smooth\n(K = 11)"
)

# explore raw
figure_3a_prelim <-
  ggplot() +
  geom_path(
    data = data_filter[time < time[1] + 12*3600 &
                         time > time[1] + 4*3600,],
    aes(X, Y,
      col = "raw",
      shape = "raw"
    ),
    size = 0.3
  ) +
  geom_path(
    data = data_smooth[time < time[1] + 12*3600 &
                         time > time[1] + 4*3600,],
    aes(X, Y,
      col = "smooth",
      shape = "smooth"
    )
    # size = 0.3
  ) +
  scale_size_area() +
  scale_colour_manual(
    name = NULL,
    values = c(
      "raw" = "grey",
      "outliers" = "red",
      "filtered" = "seagreen",
      "smooth" = "slateblue"
    ),
    labels = legend_label,
    breaks = names(legend_label)
  ) +
  scale_shape_manual(
    name = NULL,
    values = c(
      "raw" = NA,
      "outliers" = 4,
      "filtered" = 1,
      "smooth" = NA
    ),
    labels = legend_label,
    breaks = names(legend_label)
  ) +
  scale_y_continuous(breaks = 
                       c(53.245)
                     ) +
  coord_sf(
    xlim = xlim, ylim = ylim,
    crs = 32631
  ) +
  theme_test(base_family = "Arial") +
  theme(
    legend.position = c(0.6, 0.8),
    legend.text = element_text(colour = "grey50"),
    legend.background = element_rect(
      fill = "white",
      color = NA
    ),
    panel.background = element_rect(
      colour = NA
    ),
    axis.text.y = element_text(
      angle = 90,
      hjust = 0.5
    ),
    axis.title = element_blank()
  ) +
  annotation_scale(
    bar_cols = c("grey20"),
    height = unit(1, units = "mm"),
    style = "ticks",
    line_width = 1,
    line_col = "grey20",
    text_col = "grey20",
    width_hint = 0.175
  )
```

## add inset map

```{r}
# get data
nl = st_as_sf(rnaturalearthdata::countries50)
nl = nl[nl$continent == "Europe", ]

# make map
inset =
  ggplot(nl)+
    geom_sf(fill = "khaki", size = 0.2)+
    geom_point(
      x = 5, y = 53,
      shape = 21,
      size = 3,
      fill = "indianred1"
    )+
    coord_sf(
      xlim = c(-5, 10.5),
      ylim = c(43.5, 60)
    )+
    theme_void()+
    theme(
      plot.background = element_rect(
        fill = "aliceblue",
        colour = "black",
        size = 0.2
      ),
      panel.ontop = F
    )
```

```{r}
figure_3a_prelim = 
  figure_3a_prelim +
  annotation_custom(
    ggplotGrob(inset),
    xmin = xlim[2] - 60,
    xmax = xlim[2],
    ymin = ylim[2] - 100,
    ymax = ylim[2]
  )
```


```{r}
ggsave(
  figure_3a_prelim,
  filename = "figures/figure_row_3_a_preprocessing_prelim.png",
  height = 2.75, width = 5
)
```

## add red knot

```{r}
# get figure
im <- image_read("figures/figure_row_3_a_preprocessing_prelim.png")

# get red knot
knot <- image_read("figures/knots/knot_poster_picture.png")

# combine knot and figure
im <-
  im %>%
  image_composite(
    image_scale(knot, "60%x"),
    operator = "Atop",
    gravity = "SouthWest",
    offset = "-10-150"
  )

# write
image_write(
  im,
  path = "figures/figure_row_3_a_preprocessing.png"
)
```

