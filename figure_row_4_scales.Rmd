---
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r}
# data processing
library(data.table)
library(atlastools)
library(sf)

# plotting
library(ggplot2)
library(ggspatial)
library(magick)
library(patchwork)
library(colorspace)
```

```{r}
# get data
data <- fread("data/whole_season_tx_0435.csv")

# convert time to seconds from ms
data[, time := round(TIME / 1000)]

data[, time := as.POSIXct(time, tz = "Amsterdam", origin = "1970-01-01")]
```

```{r}
# get griend manual download
st_layers("data/map.osm")
griend = st_read("data/map.osm", layer = "multipolygons")
# merge into one
griend = st_union(griend)

# covnert crs
griend = st_transform(griend, 32631)
```


```{r}
# filter out before specific time
data_filter <- atl_filter_covariates(
  data = data,
  filters = "time > '2018-08-19 18:31:00 Amsterdam'"
)
```

```{r}
# add speed
data_filter[, c(
  "speed_in", "speed_out",
  "angle"
) := list(
  atl_get_speed(data_filter,
    x = "X", y = "Y", time = "time",
    type = "in"
  ),
  atl_get_speed(data_filter,
    x = "X", y = "Y", time = "time",
    type = "out"
  ),
  atl_turning_angle(data_filter, x = "X", y = "Y", time = "time")
)]
```

## remove sd and speed

```{r}
# remove high speeds
data_filter_sd_speed <- atl_filter_covariates(
  data = data_filter,
  filters = c(
    "NBS > 3",
    "SD < 100",
    "((speed_in < 20 & speed_out < 20))"
  )
)

# remove NAs
data_filter_sd_speed = na.omit(data_filter_sd_speed)
```

## do median smooth

```{r}
data_smooth <- copy(data_filter_sd_speed)

atl_median_smooth(
  data = data_smooth,
  x = "X", y = "Y", time = "TIME", moving_window = 5
)

ggplot(data_smooth)+geom_path(aes(X, Y), size = 0.1)
```

# res patch

```{r}
# require id
data_smooth[, id := "435"]
data_smooth[, TIME := NULL]

# make small copy
data_for_patch = copy(data_smooth)
data_for_patch = atl_filter_covariates(
  data_for_patch,
  filters = c("time < (time[1] + (72 * 3600))")
)

# set names
setnames(data_smooth, stringr::str_to_lower(colnames(data_smooth)))
setnames(data_for_patch, stringr::str_to_lower(colnames(data_for_patch)))

# get patch
data_patch = atl_res_patch(
  data = data_for_patch
)

# get spatials
data_patch_spatial = atl_patch_summary(data_patch,
                                       which_data = "spatial")

# set crs
# st_crs(data_patch_spatial) = 32631

bbox = st_bbox(data_patch_spatial)
```

## make overall figure


```{r}
# plot
fig_scales =
  ggplot()+
  geom_sf(data = griend,
          fill = "khaki3",
          col = NA)+
  geom_path(data = data_smooth[time < time[1] + (3600 * 360) ],
            aes(x, y),
            size = 0.1,
            # shape = ".",
            col = "steelblue")+
  geom_path(data = data_patch,
             aes(x_median, y_median),
             show.legend = F,
            size = 0.2,
             colour = "grey30")+
  geom_point(data = data_patch,
             aes(x_median, y_median,
                 size = duration,
                 fill = duration),
             show.legend = F,
             shape = 21)+
  theme_test(base_family = "Arial")+
  theme(
    panel.background = element_rect(
      fill = "aliceblue",
      colour = NA
    ),
    axis.title = element_blank(),
    axis.text.y = element_text(
      angle= 90,
      hjust = 0.5
    )
  )+
  scale_size_area(
    max_size = 10
  )+
  scale_fill_continuous_sequential(
    palette = "Sunset"
  )+
  scale_y_continuous(breaks = c(53.24, 53.25))+
  coord_sf(xlim = c(bbox["xmin"] - 200, bbox["xmax"] - 2500),
           ylim = c(bbox["ymin"] - 200, bbox["ymax"] + 00))+
  annotation_scale(
    bar_cols = c("grey50"),
    height = unit(1, units = "mm"),
    style = "ticks",
    line_width = 1.5,
    line_col = "grey50",
    text_col = "grey50",
    width_hint = 0.175, 
    location = "br"
  )
```

```{r}
ggsave(
  fig_scales,
  filename = "figures/figure_row_4_f_scales_prelim.png",
  width = 5,
  height = 4
)
```

## add red knot

```{r}
# get figure
im <- image_read("figures/figure_row_4_f_scales_prelim.png")

# get red knot
knot <- image_read("figures/knots/knot_poster_picture.png")

# combine knot and figure
im <-
  im %>%
  image_composite(
    image_scale(knot, "50%x"),
    operator = "Atop",
    gravity = "SouthWest",
    offset = "-100-100"
  )

# write
image_write(
  im,
  path = "figures/figure_row_4_f_scales.png"
)
```
